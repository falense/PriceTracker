name: Auto-merge pattern PRs (no approval required)

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-merge:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get all changed files
        id: changed-files
        run: |
          # Fetch the base branch
          git fetch origin ${{ github.base_ref }}
          
          # Get all changed files
          ALL_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "all_files=$ALL_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $ALL_FILES"
          
          # Check if all files are within generated_extractors directory
          IS_PATTERN_ONLY=true
          for file in $ALL_FILES; do
            if [[ ! "$file" =~ ^ExtractorPatternAgent/generated_extractors/ ]]; then
              echo "❌ Non-pattern file found: $file"
              IS_PATTERN_ONLY=false
              break
            fi
          done
          
          echo "is_pattern_only=$IS_PATTERN_ONLY" >> $GITHUB_OUTPUT
          
          if [ "$IS_PATTERN_ONLY" = "true" ]; then
            echo "✅ This PR only contains pattern files"
          else
            echo "⚠️ This PR contains non-pattern files - skipping auto-merge"
          fi
      
      - name: Label as pattern-only PR
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ github.event.pull_request.number }} --add-label "auto-generated-pattern"
      
      - name: Enable auto-merge
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch || echo "Auto-merge failed - may need approval or branch protection settings adjusted"
      
      - name: Add comment
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "✅ **Pattern-only PR detected**

This PR only contains extraction pattern files in \`ExtractorPatternAgent/generated_extractors/\`.

Auto-merge has been enabled. The PR will merge automatically when:
- All required status checks pass
- All required approvals are obtained (if any)

If branch protection requires approvals, please approve manually or configure the repo to allow pattern-only PRs without approval."
