name: Auto-approve pattern PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  check-and-approve:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}
      
      - name: Get all changed files
        id: changed-files
        run: |
          # Fetch the base branch
          git fetch origin ${{ github.base_ref }}
          
          # Get all changed files
          ALL_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | tr '\n' ' ')
          echo "all_files=$ALL_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $ALL_FILES"
          
          # Check if all files are within generated_extractors directory
          IS_PATTERN_ONLY=true
          for file in $ALL_FILES; do
            if [[ ! "$file" =~ ^ExtractorPatternAgent/generated_extractors/ ]]; then
              echo "‚ùå Non-pattern file found: $file"
              IS_PATTERN_ONLY=false
              break
            fi
          done
          
          echo "is_pattern_only=$IS_PATTERN_ONLY" >> $GITHUB_OUTPUT
          
          if [ "$IS_PATTERN_ONLY" = "true" ]; then
            echo "‚úÖ This PR only contains pattern files"
          else
            echo "‚ö†Ô∏è This PR contains non-pattern files - skipping auto-approval"
          fi
      
      - name: Auto-approve PR
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr review ${{ github.event.pull_request.number }} --approve --body "ü§ñ Auto-approved: This PR only modifies extraction pattern files in \`ExtractorPatternAgent/generated_extractors/\`"
      
      - name: Enable auto-merge
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --auto --squash --delete-branch
      
      - name: Add comment
        if: steps.changed-files.outputs.is_pattern_only == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "‚úÖ This PR has been automatically approved and set to auto-merge. It will merge once all required checks pass."
