name: Auto-approve and merge pattern PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'ExtractorPatternAgent/generated_extractors/**/*.py'
      - 'ExtractorPatternAgent/generated_extractors/**/*.json'

permissions:
  contents: write
  pull-requests: write

jobs:
  check-pattern-pr:
    runs-on: ubuntu-latest
    outputs:
      is_pattern_only: ${{ steps.check_files.outputs.is_pattern_only }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get changed files
        id: changed_files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            ExtractorPatternAgent/generated_extractors/**
      
      - name: Check if PR only contains pattern files
        id: check_files
        run: |
          echo "Changed files:"
          echo "${{ steps.changed_files.outputs.all_changed_files }}"
          
          # Get all changed files in the PR
          ALL_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "All changed files in PR:"
          echo "$ALL_FILES"
          
          # Check if all files are within generated_extractors directory
          IS_PATTERN_ONLY=true
          while IFS= read -r file; do
            if [[ ! "$file" =~ ^ExtractorPatternAgent/generated_extractors/ ]]; then
              echo "Non-pattern file found: $file"
              IS_PATTERN_ONLY=false
              break
            fi
          done <<< "$ALL_FILES"
          
          echo "is_pattern_only=$IS_PATTERN_ONLY" >> $GITHUB_OUTPUT
          
          if [ "$IS_PATTERN_ONLY" = "true" ]; then
            echo "‚úÖ This PR only contains pattern files"
          else
            echo "‚ùå This PR contains non-pattern files"
          fi

  auto-approve:
    needs: check-pattern-pr
    if: needs.check-pattern-pr.outputs.is_pattern_only == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Auto-approve PR
        uses: hmarr/auto-approve-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ü§ñ This PR has been automatically approved because it only contains extraction pattern files.'
            })

  run-tests:
    needs: check-pattern-pr
    if: needs.check-pattern-pr.outputs.is_pattern_only == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r ExtractorPatternAgent/requirements.txt
      
      - name: Run pattern validation tests
        run: |
          cd ExtractorPatternAgent
          python -m pytest tests/ -v || true
          echo "Pattern tests completed"

  auto-merge:
    needs: [check-pattern-pr, auto-approve, run-tests]
    if: needs.check-pattern-pr.outputs.is_pattern_only == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for status checks
        uses: lewagon/wait-on-check-action@v1.3.1
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          check-name: 'run-tests'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10
      
      - name: Auto-merge PR
        uses: pascalgn/automerge-action@v0.16.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_LABELS: ""
          MERGE_METHOD: "squash"
          MERGE_COMMIT_MESSAGE: "pull-request-title"
          MERGE_RETRIES: 6
          MERGE_RETRY_SLEEP: 10000
      
      - name: Add merge comment
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ This PR has been automatically merged. The new extraction pattern is now live!'
            })
