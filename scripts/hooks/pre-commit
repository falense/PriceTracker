#!/bin/bash
#
# Pre-commit hook to auto-update extractor versions manifest
#
# This hook runs automatically before each commit. If any extractor files
# have changed, it regenerates versions.json and stages it.
#
# To bypass this hook (not recommended):
#   git commit --no-verify
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get repository root
REPO_ROOT=$(git rev-parse --show-toplevel)
cd "$REPO_ROOT"

# Check if any extractor files are being committed
EXTRACTOR_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep "ExtractorPatternAgent/generated_extractors/.*\.py$" || true)

if [ -z "$EXTRACTOR_FILES" ]; then
    # No extractor changes, nothing to do
    exit 0
fi

echo -e "${YELLOW}[pre-commit]${NC} Extractor files changed, updating versions.json..."
echo ""

# Show which extractors changed
echo "Changed extractors:"
echo "$EXTRACTOR_FILES" | sed 's/^/  - /'
echo ""

# Regenerate versions manifest
echo "Regenerating versions manifest..."
if ! python3 scripts/generate_versions_manifest.py; then
    echo -e "${RED}[pre-commit]${NC} Failed to generate versions.json"
    echo "Please fix the errors above and try again."
    exit 1
fi

# Stage the updated manifest
MANIFEST_PATH="ExtractorPatternAgent/generated_extractors/versions.json"
if [ -f "$MANIFEST_PATH" ]; then
    git add "$MANIFEST_PATH"
    echo -e "${GREEN}[pre-commit]${NC} Staged updated $MANIFEST_PATH"
else
    echo -e "${YELLOW}[pre-commit]${NC} Warning: $MANIFEST_PATH not found"
fi

echo ""
echo -e "${GREEN}âœ“${NC} versions.json updated and staged"
exit 0
