{"id":"PriceTracker-0vi","title":"Update Django settings for centralized structlog configuration","description":"Configure structlog at Django app startup so all imported modules use consistent logging configuration. This eliminates the need for per-task logging setup.","design":"## Configuration Location\nWebUI/WebUI/settings.py or new logging.py module\n\n## Setup Requirements\n1. Initialize structlog with JSON renderer for Celery workers\n2. Configure console renderer for development\n3. Add Django context processor for request IDs\n4. Integrate with Django logging framework\n\n## Environment-based Configuration\n- Development: console output with colors\n- Production/Celery: JSON output for log aggregation","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-15T21:51:40.503151194+01:00","updated_at":"2025-12-15T22:03:38.200776032+01:00","dependencies":[{"issue_id":"PriceTracker-0vi","depends_on_id":"PriceTracker-ao8","type":"parent-child","created_at":"2025-12-15T21:52:16.537345371+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-2mr","title":"Create PriceFetcher wrapper for Celery integration","description":"Create clean wrapper functions in PriceFetcher for direct import by Celery tasks. Handle configuration loading and async context properly.","design":"## New Functions to Add\nLocation: PriceFetcher/src/celery_api.py\n\n```python\nasync def fetch_listing_price_direct(listing_id: str, db_path: str) -\u003e dict:\n    \"\"\"Direct API for Celery - fetch single listing\"\"\"\n    \nasync def fetch_all_due_prices(db_path: str) -\u003e dict:\n    \"\"\"Direct API for Celery - fetch all due products\"\"\"\n    \nasync def backfill_images_direct(db_path: str, limit: int) -\u003e dict:\n    \"\"\"Direct API for Celery - backfill images\"\"\"\n```\n\nThese wrap existing classes but provide Celery-friendly signatures.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T21:51:40.270487401+01:00","updated_at":"2025-12-15T21:59:45.076413023+01:00","closed_at":"2025-12-15T21:59:45.076413023+01:00","close_reason":"Created celery_api.py with three wrapper functions: fetch_listing_price_direct, fetch_all_due_prices, and backfill_images_direct. All functions are async, handle config loading, and return structured dictionaries.","dependencies":[{"issue_id":"PriceTracker-2mr","depends_on_id":"PriceTracker-ao8","type":"parent-child","created_at":"2025-12-15T21:52:16.367076938+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-3ra","title":"Refactor fetch_missing_images Celery task to use direct imports","description":"Rewrite fetch_missing_images() Celery task to import ImageBackfiller directly instead of using subprocess.","design":"## New Implementation\n```python\n@shared_task\nasync def fetch_missing_images():\n    from PriceFetcher.src.celery_api import backfill_images_direct\n    \n    result = await backfill_images_direct(\n        db_path=settings.DATABASE_PATH,\n        limit=50\n    )\n    \n    return result\n```\n\n## Changes\n- Remove subprocess.run()\n- Use ImageBackfiller class directly\n- Native async support","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-15T21:51:41.169999725+01:00","updated_at":"2025-12-15T21:51:41.169999725+01:00","dependencies":[{"issue_id":"PriceTracker-3ra","depends_on_id":"PriceTracker-2mr","type":"blocks","created_at":"2025-12-15T21:52:17.954836612+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-3ra","depends_on_id":"PriceTracker-0vi","type":"blocks","created_at":"2025-12-15T21:52:18.151005527+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-3ra","depends_on_id":"PriceTracker-w70","type":"blocks","created_at":"2025-12-15T21:52:18.350147204+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-665","title":"Remove parse_and_store_logs function","description":"Delete parse_and_store_logs() function from tasks.py since it's no longer needed. Update OperationLog to capture logs directly from structlog instead of parsing subprocess JSON output.","design":"## Replacement Strategy\nInstead of parsing JSON from subprocess stdout, use structlog handler to write directly to OperationLog:\n\n```python\nclass DatabaseLogHandler(logging.Handler):\n    def emit(self, record):\n        # Write to OperationLog database\n        OperationLog.objects.create(...)\n```\n\nConfigure this handler in Django settings for Celery workers.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-15T21:51:41.38119207+01:00","updated_at":"2025-12-15T21:51:41.38119207+01:00","dependencies":[{"issue_id":"PriceTracker-665","depends_on_id":"PriceTracker-c0t","type":"blocks","created_at":"2025-12-15T21:52:18.569273276+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-665","depends_on_id":"PriceTracker-nwk","type":"blocks","created_at":"2025-12-15T21:52:18.769495718+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-665","depends_on_id":"PriceTracker-3ra","type":"blocks","created_at":"2025-12-15T21:52:18.966759956+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-ao8","title":"Refactor tasks.py to use direct imports instead of subprocess","description":"Replace subprocess-based architecture in WebUI/app/tasks.py with direct Python imports. This will improve performance, error handling, and maintainability by eliminating process overhead and JSON log parsing.","design":"## Current Architecture\n- Celery tasks spawn subprocesses to run Python scripts\n- Communication via stdout/stderr with JSON logs\n- parse_and_store_logs() parses JSON from subprocess output\n- File I/O used for pattern generation results\n\n## Target Architecture\n- Direct async function calls from Celery tasks\n- Structured logging configured at Django startup\n- Return values instead of file I/O\n- Native Python exception handling\n\n## Benefits\n- Eliminate process creation overhead\n- Better error handling and stack traces\n- Simplified logging (no JSON parsing needed)\n- Easier debugging and testing\n- Reduced latency","acceptance_criteria":"- All Celery tasks use direct imports, no subprocess calls\n- Test coverage for new direct import functions\n- Logging still captured in OperationLog database\n- Pattern generation returns dict instead of file I/O\n- All existing functionality preserved\n- Performance improvement measurable (reduced task latency)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-15T21:51:39.839730175+01:00","updated_at":"2025-12-15T21:51:39.839730175+01:00"}
{"id":"PriceTracker-c0t","title":"Refactor generate_pattern Celery task to use direct imports","description":"Rewrite generate_pattern() Celery task to import PatternGenerator directly instead of using subprocess. Handle async context and remove JSON log parsing.","design":"## New Implementation\n```python\n@shared_task(bind=True, max_retries=3)\nasync def generate_pattern(self, url: str, domain: str, listing_id: str = None):\n    from ExtractorPatternAgent import PatternGenerator\n    \n    generator = PatternGenerator()\n    pattern_data = await generator.generate(url, domain)\n    \n    # Save directly to database (no file I/O)\n    pattern, created = Pattern.objects.update_or_create(...)\n    \n    # Queue fetch task if listing_id provided\n    if listing_id:\n        fetch_listing_price.delay(listing_id)\n    \n    return {'status': 'success', 'domain': domain}\n```\n\n## Changes\n- Remove subprocess.run()\n- Remove parse_and_store_logs() call\n- Remove file system scanning for pattern JSON\n- Add async support to Celery task\n- Direct exception handling (no stderr parsing)","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-15T21:51:40.699908883+01:00","updated_at":"2025-12-15T21:51:40.699908883+01:00","dependencies":[{"issue_id":"PriceTracker-c0t","depends_on_id":"PriceTracker-cnm","type":"blocks","created_at":"2025-12-15T21:52:16.873841856+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-c0t","depends_on_id":"PriceTracker-0vi","type":"blocks","created_at":"2025-12-15T21:52:17.039882706+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-c0t","depends_on_id":"PriceTracker-w70","type":"blocks","created_at":"2025-12-15T21:52:17.208525601+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-cih","title":"Update documentation for new architecture","description":"Update project documentation to reflect new direct import architecture. Document the PatternGenerator and PriceFetcher APIs for future reference.","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-15T21:51:42.079171641+01:00","updated_at":"2025-12-15T21:51:42.079171641+01:00","dependencies":[{"issue_id":"PriceTracker-cih","depends_on_id":"PriceTracker-k1q","type":"blocks","created_at":"2025-12-15T21:52:19.371306797+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-cnm","title":"Refactor ExtractorPatternAgent into proper Python package","description":"Convert ExtractorPatternAgent from standalone script to importable package. Remove sys.path hacks, fix relative imports, and create clean API for direct function calls.","design":"## Changes Required\n1. Create proper __init__.py in ExtractorPatternAgent/\n2. Remove sys.path.insert() hack in generate_pattern.py\n3. Fix relative imports (use from ExtractorPatternAgent.src.utils import ...)\n4. Create PatternGenerator class to encapsulate logic\n5. Return pattern dict instead of saving to file\n6. Accept logger as parameter instead of initializing internally\n\n## New API Structure\n```python\nclass PatternGenerator:\n    async def generate(url: str, domain: str) -\u003e dict\n    # Returns pattern data, not file path\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T21:51:40.073269359+01:00","updated_at":"2025-12-15T22:03:35.033850913+01:00","closed_at":"2025-12-15T22:03:35.033850913+01:00","close_reason":"Refactoring complete. PatternGenerator is now a proper importable Python package with no sys.path hacks, proper absolute imports, accepts logger parameter, and returns dict instead of file I/O.","dependencies":[{"issue_id":"PriceTracker-cnm","depends_on_id":"PriceTracker-ao8","type":"parent-child","created_at":"2025-12-15T21:52:16.164723199+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-k1q","title":"Update tests for refactored Celery tasks","description":"Create or update tests for all refactored Celery tasks. Verify behavior matches original subprocess-based implementation.","design":"## Test Coverage Required\n- Test generate_pattern with direct import\n- Test fetch_listing_price with direct import\n- Test fetch_missing_images with direct import\n- Mock PatternGenerator, PriceFetcher, ImageBackfiller\n- Verify OperationLog entries created correctly\n- Test error handling and retries\n- Performance benchmarks (compare to subprocess version)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-15T21:51:41.844401943+01:00","updated_at":"2025-12-15T21:51:41.844401943+01:00","dependencies":[{"issue_id":"PriceTracker-k1q","depends_on_id":"PriceTracker-665","type":"blocks","created_at":"2025-12-15T21:52:19.160585619+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-nwk","title":"Refactor fetch_listing_price Celery task to use direct imports","description":"Rewrite fetch_listing_price() Celery task to import PriceFetcher directly instead of using subprocess.","design":"## New Implementation\n```python\n@shared_task(bind=True, max_retries=3)\nasync def fetch_listing_price(self, listing_id: str):\n    from PriceFetcher.src.celery_api import fetch_listing_price_direct\n    \n    result = await fetch_listing_price_direct(\n        listing_id=listing_id,\n        db_path=settings.DATABASE_PATH\n    )\n    \n    return result\n```\n\n## Changes\n- Remove subprocess.run()\n- Remove parse_and_store_logs() call\n- Use async/await natively\n- Direct exception handling","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-15T21:51:40.954548718+01:00","updated_at":"2025-12-15T21:51:40.954548718+01:00","dependencies":[{"issue_id":"PriceTracker-nwk","depends_on_id":"PriceTracker-2mr","type":"blocks","created_at":"2025-12-15T21:52:17.412258244+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-nwk","depends_on_id":"PriceTracker-0vi","type":"blocks","created_at":"2025-12-15T21:52:17.59212734+01:00","created_by":"daemon"},{"issue_id":"PriceTracker-nwk","depends_on_id":"PriceTracker-w70","type":"blocks","created_at":"2025-12-15T21:52:17.776855003+01:00","created_by":"daemon"}]}
{"id":"PriceTracker-w70","title":"Add async support to Celery tasks","description":"Configure Celery to support async task execution since PriceFetcher and ExtractorPatternAgent use async functions. May need celery[async] or wrapper approach.","design":"## Options\n1. Use celery-aio library for native async support\n2. Wrap async functions with asyncio.run() in sync tasks\n3. Use Celery 5.3+ native async task support\n\n## Recommended Approach\nUse asyncio.run() wrapper for simplicity:\n```python\n@shared_task\ndef fetch_listing_price(listing_id: str):\n    return asyncio.run(_fetch_async(listing_id))\n\nasync def _fetch_async(listing_id: str):\n    # actual async implementation\n```","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-15T21:51:41.621664638+01:00","updated_at":"2025-12-15T22:02:47.197369258+01:00","dependencies":[{"issue_id":"PriceTracker-w70","depends_on_id":"PriceTracker-ao8","type":"parent-child","created_at":"2025-12-15T21:52:16.695712158+01:00","created_by":"daemon"}]}
