{% load currency_filters %}

{% if suggestions %}
<div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 p-6">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">
        Similar Products
        <span class="text-sm font-normal text-gray-500 dark:text-gray-400">
            (Help us identify duplicates)
        </span>
    </h3>

    <div class="space-y-4">
        {% for suggestion in suggestions %}
        <div class="border border-gray-200 dark:border-gray-700 rounded-lg p-4
                    {% if suggestion.user_vote == 1 %}bg-green-50 dark:bg-green-900/10{% elif suggestion.user_vote == -1 %}bg-red-50 dark:bg-red-900/10{% endif %}">

            <!-- Product Info -->
            <div class="flex items-start space-x-4 mb-3">
                {% if suggestion.product.image_url %}
                <img src="{% url 'proxy_image' %}?url={{ suggestion.product.image_url|urlencode }}"
                     alt="{{ suggestion.product.name }}"
                     class="w-16 h-16 object-contain rounded bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700"
                     loading="lazy">
                {% endif %}

                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">
                        {{ suggestion.product.name }}
                    </h4>
                    {% if suggestion.product.brand %}
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                        {{ suggestion.product.brand }}
                    </p>
                    {% endif %}
                    {% if suggestion.best_listing %}
                    <p class="text-sm font-semibold text-green-600 dark:text-green-400 mt-1">
                        {{ suggestion.best_listing.current_price|format_currency:suggestion.best_listing.currency }}
                    </p>
                    <a href="{{ suggestion.best_listing.url }}"
                       target="_blank"
                       rel="noopener noreferrer"
                       class="text-xs text-blue-600 dark:text-blue-400 hover:underline inline-flex items-center gap-1">
                        {{ suggestion.best_listing.store.name }}
                        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                    </a>
                    {% endif %}
                </div>

                <!-- Similarity Badge -->
                <span class="px-2 py-1 text-xs font-medium rounded
                             {% if suggestion.similarity_score >= 90 %}bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-200
                             {% elif suggestion.similarity_score >= 80 %}bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200
                             {% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300{% endif %}">
                    {{ suggestion.similarity_score|floatformat:0 }}% match
                </span>
            </div>

            <!-- Vote Buttons -->
            <div class="flex items-center justify-between">
                <div class="flex space-x-2">
                    <button
                        hx-post="{% url 'vote_product_relation' subscription.id %}"
                        hx-vals='{"suggested_product_id": "{{ suggestion.product.id }}", "vote": "same"}'
                        hx-target="#similar-products-container"
                        hx-swap="innerHTML"
                        class="px-3 py-1.5 text-sm rounded
                               {% if suggestion.user_vote == 1 %}bg-green-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-green-50 dark:hover:bg-green-900/20{% endif %}">
                        üëç Same Product
                    </button>

                    <button
                        hx-post="{% url 'vote_product_relation' subscription.id %}"
                        hx-vals='{"suggested_product_id": "{{ suggestion.product.id }}", "vote": "different"}'
                        hx-target="#similar-products-container"
                        hx-swap="innerHTML"
                        class="px-3 py-1.5 text-sm rounded
                               {% if suggestion.user_vote == -1 %}bg-red-600 text-white{% else %}bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-red-50 dark:hover:bg-red-900/20{% endif %}">
                        üëé Different
                    </button>

                    <button
                        hx-post="{% url 'vote_product_relation' subscription.id %}"
                        hx-vals='{"suggested_product_id": "{{ suggestion.product.id }}", "vote": "dismiss"}'
                        hx-target="#similar-products-container"
                        hx-swap="innerHTML"
                        class="px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                        Dismiss
                    </button>
                </div>

                <!-- Aggregate Stats -->
                {% if suggestion.aggregate.total_votes > 0 %}
                <span class="text-xs text-gray-500 dark:text-gray-400">
                    Agreement: {% widthratio suggestion.aggregate.upvotes suggestion.aggregate.total_votes 100 %}% ({{ suggestion.aggregate.total_votes }} vote{{ suggestion.aggregate.total_votes|pluralize }})
                </span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}
