# Generated Extractors

This directory contains auto-generated Python extractors for e-commerce websites.

## Structure

Each extractor is a Python module named after the domain (with dots replaced by underscores):

```
generated_extractors/
├── __init__.py              # Registry and discovery API
├── _base.py                 # Base classes and utilities
├── example_com.py           # Example extractor (reference)
├── komplett_no.py           # Auto-generated extractor
└── amazon_com.py            # Auto-generated extractor
```

## Usage

### Get Parser for Domain

```python
from ExtractorPatternAgent.generated_extractors import get_parser

parser = get_parser("komplett.no")
if parser:
    soup = BeautifulSoup(html, 'html.parser')
    price = parser.extract_price(soup)
```

### High-Level API

```python
from ExtractorPatternAgent.generated_extractors import extract_from_html

result = extract_from_html("komplett.no", html)
if result.success:
    print(f"Price: {result.price}")
    print(f"Title: {result.title}")
else:
    print(f"Errors: {result.errors}")
```

### List Available Extractors

```python
from ExtractorPatternAgent.generated_extractors import list_available_extractors

extractors = list_available_extractors()
for domain, metadata in extractors.items():
    print(f"{domain}: confidence={metadata['confidence']}")
```

## Extractor Structure

Each extractor module must have:

1. **PATTERN_METADATA** dict with:
   - `domain` (str): Domain name (e.g., "komplett.no")
   - `generated_at` (str): ISO timestamp
   - `confidence` (float): Overall confidence (0.0-1.0)
   - `fields` (list): List of extracted fields

2. **Extract functions**:
   - `extract_price(soup) -> Optional[Decimal]`
   - `extract_title(soup) -> Optional[str]`
   - `extract_image(soup) -> Optional[str]`
   - `extract_availability(soup) -> Optional[str]`
   - `extract_article_number(soup) -> Optional[str]`
   - `extract_model_number(soup) -> Optional[str]`

## Example Extractor

See `example_com.py` for a reference implementation.

```python
# minimal_extractor.py
from decimal import Decimal
from typing import Optional
from bs4 import BeautifulSoup
from ._base import BaseExtractor

PATTERN_METADATA = {
    'domain': 'minimal.com',
    'generated_at': '2025-12-17T00:00:00Z',
    'confidence': 0.95,
    'fields': ['price', 'title']
}

def extract_price(soup: BeautifulSoup) -> Optional[Decimal]:
    elem = soup.select_one('.price')
    if elem:
        return BaseExtractor.clean_price(elem.get_text())
    return None

def extract_title(soup: BeautifulSoup) -> Optional[str]:
    elem = soup.select_one('h1')
    if elem:
        return BaseExtractor.clean_text(elem.get_text())
    return None

# ... other extract_* functions ...
```

## Runtime Discovery

The registry automatically discovers all `.py` files in this directory (excluding `_*.py`).
No manual registration needed - just add a new extractor module and it will be picked up automatically.

## Development

### Hot Reload (Development Only)

```python
from ExtractorPatternAgent.generated_extractors import reload_extractors

# After editing an extractor
reload_extractors()
```

### Testing

Test individual extractors:

```python
from ExtractorPatternAgent.generated_extractors.komplett_no import extract_price
from bs4 import BeautifulSoup

soup = BeautifulSoup(html, 'html.parser')
price = extract_price(soup)
assert price is not None
```

## Generation

Extractors are generated by `ExtractorPatternAgent`:

```python
from ExtractorPatternAgent import PatternGenerator

generator = PatternGenerator()
python_code = await generator.generate_python_module(
    url="https://www.komplett.no/product/123",
    domain="komplett.no"
)

# Saves to: generated_extractors/komplett_no.py
```

## Base Utilities

The `BaseExtractor` class provides common utilities:

- `clean_price(text)` - Parse prices in various formats
- `clean_text(text)` - Clean and normalize text
- `extract_json_field(data, path)` - Extract from nested JSON

Use these in your extractors for consistency.
